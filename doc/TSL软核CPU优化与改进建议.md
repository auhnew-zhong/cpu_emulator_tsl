# TSL软核CPU优化与改进建议

## 总体评价
- 架构分层清晰：CPU核心、总线/DRAM、信息库(DB)、主入口、工具脚本。
- 指令实现与 `inst_format.md` 大体一致，具备端到端加载与运行能力。
- 仍有结构性优化空间：解码器扩展性、错误处理与日志、时序语义、测试与CI、工具脚本一致性。

## 指令执行与解码
- 表驱动解码
  - 现状：`decode_*` 使用多层 `switch`，扩展成本高。
  - 建议：构建“opcode → 长度 → exec函数指针”的查表式解码器，减少分支复杂度，便于新增指令与重构。
- MOV 长度判定一致性
  - 现状：`getInstLength` 依赖高48位全0 + func位判断 2B MOV，脚本已仅用 func 位判断。
  - 建议：与脚本对齐，仅基于 func 位区分 2B/8B，避免对高位的假设。
- 边沿检测增强
  - 现状：`edge_detect` 支持 P/N/H/L/E 五模式。
  - 建议：扩展多位联合边沿检测（如多bit同时判定），增强复杂信号识别能力。

## 时序与运行语义
- 计时器/域联动
  - 现状：`timer_set/domain_set` 的输出打印与状态变量更新未影响执行节拍或采样窗口。
  - 建议：在 `cpu_execute` 循环中实现周期累积与域内采样窗口，使 `timer_set/domain_set` 对执行有可见影响（如窗口内的边沿/显示/执行条件）。
- 跳转与调用语义
  - 现状：`jmpc/jmp/bl/ret` 行为正确，偏移符号扩展规范。
  - 建议：增加调用栈保护与断点/单步（可选），提升调试与错误保护能力。

## 内存与总线
- 信号模型
  - 现状：示例 `signal_table` 支持简单地址→值映射；未命中返回0并打印错误。
  - 建议：引入更真实的映射层，支持域/宽度/掩码，增加越界与对齐校验；可考虑按 `.db` 配置信号源与宽度。
- DRAM访问
  - 建议：统一对齐策略与越界错误码，避免断言；增加读写统计与监控接口以便性能分析。

## 错误处理与日志
- 开发断言与生产容错分离
  - 现状：个别路径仍使用 `assert(0)`（如 MOVI func 校验失败）。
  - 建议：定义错误码与统一处理逻辑，保留详细日志并优雅退出；断言仅用于开发模式。
- ANSI 颜色开关
  - 现状：已支持 `set_ansi_color_enabled`，日志文件为纯文本。
  - 建议：自动检测非TTY禁用颜色，并提供命令行参数 `--no-color` 控制。

## 信息库(DB)
- 解析健壮性
  - 现状：依赖简单字符串拆分；容错有限。
  - 建议：增加 trim/注释支持/字段校验，对异常行给出定位并忽略；允许 fallback 路径（如 `examples/` 或 `TSL_INFO_BASE` 环境变量）。
- 启动打印
  - 现状：打印总览“DB载入【DISPLAY】【EXEC】【DOMAIN】【TIMER】”。
  - 建议：增加缺失类目明确计数为0，并在日志中标注未加载原因，便于排查。

## 工具脚本
- BinToAsm 输出一致性
  - 现状：长度判定与分派对齐；`timer_set/2B mov` 修复；尾部 padding 截断；助记与寄存器风格统一。
  - 建议：为 `arith_op.func` 映射助记（`and/or/xor/redu_* /concat/isunknown/add/sub`），列宽与格式对齐 `.diss`，并为非法序列提供明确错误提示。
- BinToMem
  - 建议：增加校验（非法指令标注偏移），可选输出偏移注释以提升可读性。

## 测试与CI
- 单元测试
  - 建议：覆盖关键语义：`jmpc` 条件与偏移、`edge_detect` 五模式、`bit_slice` 掩码与边界、`arith_op` 全分支、`timer_set/domain_set` 状态变更。
- 集成测试
  - 建议：以 `.mem` + `.db` 组合构造场景，验证端到端输出一致性（包括反汇编与运行日志）。
- CI 构建
  - 建议：添加基础 CI（编译、脚本运行、单元与集成测试），保障改动稳定与回归保护。

## 文档与图表
- 设计文档深化
  - 现状：已加入 Mermaid/PlantUML 图表与图片嵌入位点。
  - 建议：补充各指令微架构序列与执行/写回细节；提供生成脚本把 `.mmd/.puml` 渲染为 PNG/SVG 并嵌入到文档。

## 配置与CLI
- 命令行参数建议
  - `--info-base` 指定信息库目录
  - `--no-color` 关闭ANSI颜色
  - `--log-level` 控制打印级别（error/warn/info/debug）
  - `--trace` 输出取指/解码/执行详细trace，便于排查

## 性能建议
- 打印与IO
  - 建议：增加打印级别与节流，减少高频IO干扰执行性能；对批量打印提供缓冲策略。
- 解码缓存
  - 建议：引入简单直通缓存（cache上一条或数条指令的解析结果），降低重复解析带来的CPU开销。

## 优先级路线图
1. 近期落地
   - 错误码替代断言与统一日志
   - `arith_op.func` 助记映射
   - DB解析健壮性与fallback策略
   - ANSI自动禁用与 `--no-color` 参数
2. 中期实施
   - 表驱动解码器
   - 计时器/域联动时序语义
   - 单元/集成测试与基础CI
3. 后续深化
   - 更真实的信号/内存模型
   - 多域采样窗口模拟
   - 断点/单步与调试接口集成

